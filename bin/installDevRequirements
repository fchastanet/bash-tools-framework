#!/usr/bin/env bash

BIN_DIR=$(cd "$(readlink -e "${BASH_SOURCE[0]%/*}")" && pwd -P)
ROOT_DIR="$(cd "${BIN_DIR}/.." && pwd -P)"
SRC_DIR="$(cd "${ROOT_DIR}/src" && pwd -P)"
export FRAMEWORK_DIR="${ROOT_DIR}"

# shellcheck source=src/_includes/_header.sh
source "${SRC_DIR}/_includes/_header.sh"
# shellcheck source=src/Env/load.sh
source "${SRC_DIR}/Env/load.sh"
# shellcheck source=src/Log/__all.sh
source "${SRC_DIR}/Log/__all.sh"
# shellcheck source=src/Args/defaultHelp.sh
source "${SRC_DIR}/Args/defaultHelp.sh"
# shellcheck source=src/Args/defaultHelpNoExit.sh
source "${SRC_DIR}/Args/defaultHelpNoExit.sh"
# shellcheck source=src/Args/showHelp.sh
source "${SRC_DIR}/Args/showHelp.sh"
# shellcheck source=src/Git/shallowClone.sh
source "${SRC_DIR}/Git/shallowClone.sh"

# shellcheck source=src/_includes/executedAsUser.sh
source "${SRC_DIR}/_includes/executedAsUser.sh"

HELP="$(
  cat <<EOF
${__HELP_TITLE}Description:${__HELP_NORMAL} installs all requirements
unit testing, fchastanet/bash-tools
${__HELP_TITLE}Usage:${__HELP_NORMAL} ${SCRIPT_NAME}
EOF
)"
Args::defaultHelp "${HELP}" "$@"

FCHASTANET_REPO="https://raw.githubusercontent.com/fchastanet/bash-tools/master/bin"
installBin() {
  local bin="$1"
  Log::displayInfo "Installing ${BIN_DIR}/${bin}"
  curl -s -L "${FCHASTANET_REPO}/${bin}" >"${BIN_DIR}/${bin}"
  chmod +x "${BIN_DIR}/${bin}"
}
installBin "awkLint"
installBin "shellcheckLint"
installBin "test"
installBin "runBuildContainer"

Git::shallowClone \
  "https://github.com/bats-core/bats-core.git" \
  "${ROOT_DIR}/vendor/bats" \
  "master" \
  "FORCE_DELETION"

# last revision 2019
Git::shallowClone \
  "https://github.com/bats-core/bats-support.git" \
  "${ROOT_DIR}/vendor/bats-support" \
  "master" \
  "FORCE_DELETION"

Git::shallowClone \
  "https://github.com/bats-core/bats-assert.git" \
  "${ROOT_DIR}/vendor/bats-assert" \
  "master" \
  "FORCE_DELETION"

Git::shallowClone \
  "https://github.com/Flamefire/bats-mock.git" \
  "${ROOT_DIR}/vendor/bats-mock-Flamefire" \
  "master" \
  "FORCE_DELETION"
